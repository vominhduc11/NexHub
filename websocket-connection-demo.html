<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Connection Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .logs {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 15px;
            margin: 15px 0;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-test { background-color: #007bff; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }
        .btn-disconnect { background-color: #dc3545; color: white; }
        .token-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }
        .login-form {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .login-form h4 {
            margin-top: 0;
            color: #495057;
        }
        .login-form input, .login-form select {
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 14px;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ WebSocket Connection Demo</h1>
        <p><strong>Purpose:</strong> Test WebSocket authentication v·ªõi v√† kh√¥ng c√≥ JWT token</p>
        
        <!-- Test 1: Without Token -->
        <div class="test-section">
            <h2>‚ùå Test 1: Connection WITHOUT Token (Should Fail)</h2>
            <p>This test attempts to connect without any authentication token. Should be rejected by security interceptor.</p>
            
            <div>
                <span class="status-indicator" id="status1"></span>
                <span id="statusText1">Disconnected</span>
            </div>
            
            <button class="btn-test" onclick="testWithoutToken()">Test Without Token</button>
            <button class="btn-clear" onclick="clearLogs('logs1')">Clear Logs</button>
            <button class="btn-disconnect" onclick="disconnect1()">Disconnect</button>
            
            <div class="logs" id="logs1"></div>
        </div>

        <!-- Test 2: With Valid Token -->
        <div class="test-section">
            <h2>‚úÖ Test 2: Connection WITH Valid Token (Should Work)</h2>
            <p>This test uses a valid JWT token from login. Should be accepted by security interceptor.</p>
            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 12px;">
                <strong>üìù Technical Analysis:</strong> 
                <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
                    <li><strong>‚úÖ Direct Connection:</strong> Works perfectly with CORS + JWT authentication</li>
                    <li><strong>‚ùå API Gateway Issue:</strong> CORS preflight (OPTIONS) returns 403 Forbidden</li>
                    <li><strong>üîç Root Cause:</strong> Spring Cloud Gateway CORS configuration not applying to WebSocket endpoints</li>
                    <li><strong>üéØ Recommendation:</strong> Use direct connection for WebSocket, API Gateway for REST APIs</li>
                </ul>
            </div>
            
            <div>
                <span class="status-indicator" id="status2"></span>
                <span id="statusText2">Disconnected</span>
            </div>
            
            <!-- Login Form -->
            <div class="login-form" id="loginForm">
                <h4>üîë Login to get fresh token:</h4>
                <input type="text" id="username" placeholder="Username" value="admin" style="margin: 5px; padding: 8px; width: 120px;">
                <input type="password" id="password" placeholder="Password" value="admin123" style="margin: 5px; padding: 8px; width: 120px;">
                <select id="userType" style="margin: 5px; padding: 8px; width: 100px;">
                    <option value="ADMIN">ADMIN</option>
                    <option value="DEALER">DEALER</option>
                    <option value="CUSTOMER">CUSTOMER</option>
                </select>
                <button class="btn-test" onclick="login()">Login</button>
            </div>
            
            <button class="btn-test" onclick="testWithCurrentToken()" id="testTokenBtn">üîó Test Direct Connection</button>
            <button class="btn-test" onclick="testViaDirectConnection()" id="testDirectBtn">‚úÖ Test via Direct Service (RECOMMENDED)</button>
            <button class="btn-test" onclick="testWithPresetToken()">Test With Preset Token</button>
            <button class="btn-clear" onclick="clearToken()">Clear Token</button>
            <button class="btn-clear" onclick="clearLogs('logs2')">Clear Logs</button>
            <button class="btn-disconnect" onclick="disconnect2()">Disconnect</button>
            
            <div class="token-info" id="tokenInfo" style="display:none;">
                <strong>Current Token:</strong><br>
                <span id="tokenDisplay"></span>
            </div>
            
            <div class="logs" id="logs2"></div>
        </div>

        <!-- Test 3: With Invalid Token -->
        <div class="test-section">
            <h2>‚ùå Test 3: Connection WITH Invalid Token (Should Fail)</h2>
            <p>This test uses a fake/invalid token. Should be rejected by token validation.</p>
            
            <div>
                <span class="status-indicator" id="status3"></span>
                <span id="statusText3">Disconnected</span>
            </div>
            
            <button class="btn-test" onclick="testWithInvalidToken()">Test With Invalid Token</button>
            <button class="btn-clear" onclick="clearLogs('logs3')">Clear Logs</button>
            <button class="btn-disconnect" onclick="disconnect3()">Disconnect</button>
            
            <div class="logs" id="logs3"></div>
        </div>
    </div>

    <script>
        let stompClient1 = null;
        let stompClient2 = null;
        let stompClient3 = null;
        let currentToken = localStorage.getItem('nexhub_jwt_token') || "eyJraWQiOiJmZTNhNGUxMi1kYjc1LTRkY2YtODNlZS00NmMzYTE1ZTBmZTUiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiIxOSIsInVzZXJuYW1lIjoiYWRtaW4iLCJ1c2VyVHlwZSI6IkFETUlOIiwicm9sZXMiOlsiQURNSU4iXSwicGVybWlzc2lvbnMiOltdLCJpYXQiOjE3NTYzNzUwNTIsImV4cCI6MTc1NjQ2MTQ1MiwiaXNzIjoiYXV0aC1zZXJ2aWNlIiwiYXVkIjoibmV4aHViLXNlcnZpY2VzIn0.xbzdl82Mu9FamFnvd-Blh02QLtUYdE76QytTsbbwowEzmyrNY_lOrw_FnTkDEqkeHZJp7-hp5daiXiMkmzrDHwcscRhh2JWJ90n39pXpGk14TVjynlRjOiwSiA-0lk9Ya17D1JXgSBbxKvE2UvgxJRKdZUpucsLFHgA0RAOqLzhvxULggGzMwry3e1ent5QiyhQHPUtlvk_wBjcq8SURhyhe6okKZ-li6fZ1YNME1L49DlXBOiMqRFQq9dd4mAIe_hgQgUmQBlerfrl-0jPkIY717OV_kAL__0-rnNk3pB2zU-PAuKXGDBntmug0_gwxdaTLl5BDgNyAiEyQso-XMw";

        function log(message, type = 'info', logId = 'logs1') {
            const logsDiv = document.getElementById(logId);
            const time = new Date().toLocaleTimeString();
            const logLine = `[${time}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = type;
            span.textContent = logLine;
            
            logsDiv.appendChild(span);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`${logId} - ${type.toUpperCase()}: ${message}`);
        }

        function setStatus(testNum, status, text) {
            const statusElement = document.getElementById(`status${testNum}`);
            const textElement = document.getElementById(`statusText${testNum}`);
            
            statusElement.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        function clearLogs(logId) {
            document.getElementById(logId).innerHTML = '';
        }

        // Test 1: Without Token
        function testWithoutToken() {
            log("üß™ Starting connection test WITHOUT token...", 'info', 'logs1');
            setStatus(1, 'connecting', 'Connecting...');
            
            const socket = new SockJS('http://localhost:8080/api/notification/ws/notifications');
            stompClient1 = Stomp.over(socket);
            
            // Disable debug to avoid spam
            stompClient1.debug = function(str) {
                log(`STOMP: ${str}`, 'info', 'logs1');
            };
            
            // Connect without any headers
            const headers = {};
            log("Headers: (empty)", 'info', 'logs1');
            
            stompClient1.connect(headers, 
                function(frame) {
                    log("‚ùå SECURITY ISSUE: Connection succeeded without token!", 'error', 'logs1');
                    log(`Frame: ${frame}`, 'error', 'logs1');
                    setStatus(1, 'connected', 'Connected (SECURITY ISSUE!)');
                }, 
                function(error) {
                    log("‚úÖ EXPECTED: Connection failed without token", 'success', 'logs1');
                    log(`Error: ${error}`, 'success', 'logs1');
                    setStatus(1, 'disconnected', 'Rejected (Expected)');
                }
            );
        }

        function disconnect1() {
            if (stompClient1 !== null) {
                stompClient1.disconnect();
                stompClient1 = null;
            }
            setStatus(1, 'disconnected', 'Disconnected');
            log("Manual disconnect", 'info', 'logs1');
        }

        // Test 2: Login Function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            
            log("üîë Attempting login...", 'info', 'logs2');
            setStatus(2, 'connecting', 'Logging in...');
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        userType: userType
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.token) {
                    currentToken = data.data.token;
                    
                    // Save token to localStorage
                    localStorage.setItem('nexhub_jwt_token', currentToken);
                    log(`‚úÖ Login successful! Got token for user: ${data.data.user.username} (${data.data.user.userType})`, 'success', 'logs2');
                    log(`üíæ Token saved to localStorage`, 'info', 'logs2');
                    
                    // Show token info
                    document.getElementById('tokenInfo').style.display = 'block';
                    document.getElementById('tokenDisplay').textContent = currentToken.substring(0, 100) + '...';
                    
                    // Enable test button
                    document.getElementById('testTokenBtn').disabled = false;
                    
                    // Parse token to show details
                    try {
                        const payload = JSON.parse(atob(currentToken.split('.')[1]));
                        log(`Token details: username=${payload.username}, userType=${payload.userType}, roles=${payload.roles}, expires=${new Date(payload.exp * 1000).toLocaleString()}`, 'info', 'logs2');
                    } catch (e) {
                        log(`Token parse error: ${e.message}`, 'warning', 'logs2');
                    }
                    
                    setStatus(2, 'disconnected', 'Ready with Token');
                } else {
                    log(`‚ùå Login failed: ${data.message}`, 'error', 'logs2');
                    setStatus(2, 'disconnected', 'Login Failed');
                }
            } catch (error) {
                log(`‚ùå Login request failed: ${error.message}`, 'error', 'logs2');
                setStatus(2, 'disconnected', 'Login Error');
            }
        }
        
        // Test WebSocket with current token
        function testWithCurrentToken() {
            if (!currentToken) {
                log("‚ùå No token available. Please login first.", 'error', 'logs2');
                return;
            }
            testWithValidToken();
        }

        // Clear token from localStorage
        function clearToken() {
            localStorage.removeItem('nexhub_jwt_token');
            currentToken = null;
            document.getElementById('tokenInfo').style.display = 'none';
            document.getElementById('testTokenBtn').disabled = true;
            log("üóëÔ∏è Token cleared from localStorage", 'warning', 'logs2');
        }

        // Check and display token on page load
        function checkStoredToken() {
            if (currentToken && currentToken !== "eyJraWQiOiJmZTNhNGUxMi1kYjc1LTRkY2YtODNlZS00NmMzYTE1ZTBmZTUiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiIxOSIsInVzZXJuYW1lIjoiYWRtaW4iLCJ1c2VyVHlwZSI6IkFETUlOIiwicm9sZXMiOlsiQURNSU4iXSwicGVybWlzc2lvbnMiOltdLCJpYXQiOjE3NTYzNzUwNTIsImV4cCI6MTc1NjQ2MTQ1MiwiaXNzIjoiYXV0aC1zZXJ2aWNlIiwiYXVkIjoibmV4aHViLXNlcnZpY2VzIn0.xbzdl82Mu9FamFnvd-Blh02QLtUYdE76QytTsbbwowEzmyrNY_lOrw_FnTkDEqkeHZJp7-hp5daiXiMkmzrDHwcscRhh2JWJ90n39pXpGk14TVjynlRjOiwSiA-0lk9Ya17D1JXgSBbxKvE2UvgxJRKdZUpucsLFHgA0RAOqLzhvxULggGzMwry3e1ent5QiyhQHPUtlvk_wBjcq8SURhyhe6okKZ-li6fZ1YNME1L49DlXBOiMqRFQq9dd4mAIe_hgQgUmQBlerfrl-0jPkIY717OV_kAL__0-rnNk3pB2zU-PAuKXGDBntmug0_gwxdaTLl5BDgNyAiEyQso-XMw") {
                log("üì± Found stored token in localStorage", 'info', 'logs2');
                
                // Show token info
                document.getElementById('tokenInfo').style.display = 'block';
                document.getElementById('tokenDisplay').textContent = currentToken.substring(0, 100) + '...';
                
                // Parse token to show details
                try {
                    const payload = JSON.parse(atob(currentToken.split('.')[1]));
                    const isExpired = payload.exp < (Date.now() / 1000);
                    log(`Stored token: username=${payload.username}, userType=${payload.userType}, expired=${isExpired}`, isExpired ? 'warning' : 'info', 'logs2');
                    
                    if (isExpired) {
                        log("‚ö†Ô∏è Stored token is expired. Please login again.", 'warning', 'logs2');
                    }
                } catch (e) {
                    log(`Token parse error: ${e.message}`, 'warning', 'logs2');
                }
            }
        }

        function testWithPresetToken() {
            log("üß™ Testing connection with PRESET token...", 'info', 'logs2');
            
            // Show token info
            document.getElementById('tokenInfo').style.display = 'block';
            document.getElementById('tokenDisplay').textContent = currentToken.substring(0, 100) + '...';
            
            // Parse token to show details
            try {
                const payload = JSON.parse(atob(currentToken.split('.')[1]));
                log(`Token details: username=${payload.username}, userType=${payload.userType}, expires=${new Date(payload.exp * 1000).toLocaleString()}`, 'info', 'logs2');
                
                // Check if expired
                const isExpired = payload.exp < (Date.now() / 1000);
                log(`Token expired: ${isExpired}`, isExpired ? 'error' : 'success', 'logs2');
            } catch (e) {
                log(`Token parse error: ${e.message}`, 'warning', 'logs2');
            }
            
            // Now test WebSocket connection
            testWithValidToken();
        }

        // Test via API Gateway
        function testViaDirectConnection() {
            if (!currentToken) {
                log("‚ùå No token available. Please login first.", 'error', 'logs2');
                return;
            }
            
            log("üîó Testing connection via DIRECT SERVICE...", 'info', 'logs2');
            setStatus(2, 'connecting', 'Connecting directly to notification service...');
            
            const socket = new SockJS('http://localhost:8083/ws/notifications');
            const stompClient = Stomp.over(socket);
            
            stompClient.debug = function(str) {
                log(`DIRECT STOMP: ${str}`, 'info', 'logs2');
            };
            
            const headers = {
                'Authorization': 'Bearer ' + currentToken
            };
            log("Headers: Authorization Bearer [TOKEN] direct to service", 'info', 'logs2');
            
            stompClient.connect(headers, 
                function(frame) {
                    log("‚úÖ SUCCESS: Direct service connection established!", 'success', 'logs2');
                    log(`Direct Frame: ${frame}`, 'success', 'logs2');
                    setStatus(2, 'connected', 'Connected Successfully');
                    
                    try {
                        stompClient.subscribe('/topic/dealer-registrations', function(message) {
                            log(`üì® Direct received: ${message.body}`, 'success', 'logs2');
                        });
                        log("‚úÖ Direct subscribed to /topic/dealer-registrations", 'success', 'logs2');
                    } catch (e) {
                        log(`‚ùå Direct subscription failed: ${e.message}`, 'error', 'logs2');
                    }
                    
                    setTimeout(() => {
                        stompClient.disconnect();
                        log("üîå Direct connection disconnected", 'info', 'logs2');
                        setStatus(2, 'disconnected', 'Disconnected');
                    }, 8000);
                }, 
                function(error) {
                    log("‚ùå Direct service connection failed", 'error', 'logs2');
                    log(`Direct Error: ${error}`, 'error', 'logs2');
                    setStatus(2, 'disconnected', 'Connection Failed');
                }
            );
        }

        function testWithValidToken() {
            log("üß™ Testing connection WITH valid token...", 'info', 'logs2');
            setStatus(2, 'connecting', 'Connecting with token...');
            
            // Direct connection to notification service (recommended)
            log("üîó Connecting directly to notification service...", 'info', 'logs2');
            const socket = new SockJS('http://localhost:8083/ws/notifications');
            stompClient2 = Stomp.over(socket);
            
            stompClient2.debug = function(str) {
                log(`STOMP: ${str}`, 'info', 'logs2');
            };
            
            const headers = {
                'Authorization': 'Bearer ' + currentToken
            };
            log("Headers: Authorization Bearer [TOKEN] ‚Üí Direct Service", 'info', 'logs2');
            
            stompClient2.connect(headers, 
                function(frame) {
                    log("‚úÖ SUCCESS: Direct connection established with valid token!", 'success', 'logs2');
                    log(`Frame: ${frame}`, 'success', 'logs2');
                    setStatus(2, 'connected', 'Connected Successfully');
                    
                    // Try to subscribe to a topic
                    try {
                        stompClient2.subscribe('/topic/dealer-registrations', function(message) {
                            log(`üì® Received message: ${message.body}`, 'success', 'logs2');
                        });
                        log("‚úÖ Subscribed to /topic/dealer-registrations", 'success', 'logs2');
                    } catch (e) {
                        log(`‚ùå Subscription failed: ${e.message}`, 'error', 'logs2');
                    }
                }, 
                function(error) {
                    log("‚ùå Direct connection failed with valid token", 'error', 'logs2');
                    log(`Error: ${error}`, 'error', 'logs2');
                    setStatus(2, 'disconnected', 'Connection Failed');
                }
            );
        }

        function disconnect2() {
            if (stompClient2 !== null) {
                stompClient2.disconnect();
                stompClient2 = null;
            }
            setStatus(2, 'disconnected', 'Disconnected');
            log("Manual disconnect", 'info', 'logs2');
        }

        // Test 3: With Invalid Token
        function testWithInvalidToken() {
            log("üß™ Testing connection WITH invalid token...", 'info', 'logs3');
            setStatus(3, 'connecting', 'Connecting with invalid token...');
            
            const socket = new SockJS('http://localhost:8080/api/notification/ws/notifications');
            stompClient3 = Stomp.over(socket);
            
            stompClient3.debug = function(str) {
                log(`STOMP: ${str}`, 'info', 'logs3');
            };
            
            const fakeToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJmYWtlIiwidXNlcm5hbWUiOiJmYWtlIiwidXNlclR5cGUiOiJGQUtFIiwiaWF0IjoxNjAwMDAwMDAwLCJleHAiOjE2MDAwMDAwMDB9.invalid";
            
            const headers = {
                'Authorization': 'Bearer ' + fakeToken
            };
            log("Headers: Authorization Bearer [FAKE_TOKEN]", 'warning', 'logs3');
            
            stompClient3.connect(headers, 
                function(frame) {
                    log("‚ùå SECURITY ISSUE: Connection succeeded with invalid token!", 'error', 'logs3');
                    log(`Frame: ${frame}`, 'error', 'logs3');
                    setStatus(3, 'connected', 'Connected (SECURITY ISSUE!)');
                }, 
                function(error) {
                    log("‚úÖ EXPECTED: Connection failed with invalid token", 'success', 'logs3');
                    log(`Error: ${error}`, 'success', 'logs3');
                    setStatus(3, 'disconnected', 'Rejected (Expected)');
                }
            );
        }

        function disconnect3() {
            if (stompClient3 !== null) {
                stompClient3.disconnect();
                stompClient3 = null;
            }
            setStatus(3, 'disconnected', 'Disconnected');
            log("Manual disconnect", 'info', 'logs3');
        }

        // Initialize
        log("WebSocket Connection Demo ready. Click buttons to start tests.", 'info', 'logs1');
        log("This will test authentication behavior.", 'info', 'logs2');
        log("This will test invalid token handling.", 'info', 'logs3');
        
        setStatus(1, 'disconnected', 'Ready');
        setStatus(2, 'disconnected', 'Ready');
        setStatus(3, 'disconnected', 'Ready');
        
        // Check for stored token on page load
        checkStoredToken();
    </script>
</body>
</html>