<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Comparison Demo - API Gateway vs Direct</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .comparison-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .connection-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel-header {
            background: #007cba;
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .gateway-panel .panel-header {
            background: #28a745;
        }
        .direct-panel .panel-header {
            background: #dc3545;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #f9f9f9;
        }
        .section h4 { 
            margin-top: 0; 
            color: #333;
        }
        input, button, select { 
            margin: 5px; 
            padding: 8px 12px; 
        }
        input[type="text"], input[type="password"] { 
            width: 180px; 
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px; 
            font-weight: bold;
        }
        button:hover { 
            background: #005a87; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .gateway-panel button {
            background: #28a745;
        }
        .gateway-panel button:hover {
            background: #218838;
        }
        .direct-panel button {
            background: #dc3545;
        }
        .direct-panel button:hover {
            background: #c82333;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .status.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .messages { 
            height: 250px; 
            overflow-y: auto; 
            background: #fff; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message { 
            margin: 3px 0; 
            padding: 3px 6px; 
            border-radius: 3px;
        }
        .message.received { 
            background: #e7f3ff; 
            border-left: 3px solid #007cba;
        }
        .message.sent { 
            background: #fff3cd; 
            border-left: 3px solid #ffc107;
        }
        .message.system { 
            background: #f8f9fa; 
            font-style: italic; 
            color: #6c757d;
            border-left: 3px solid #6c757d;
        }
        .message.error { 
            background: #f8d7da; 
            color: #721c24;
            border-left: 3px solid #dc3545;
        }
        .connection-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .login-shared {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .endpoint-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 8px;
            border-radius: 3px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ WebSocket Connection Comparison</h1>
        <p>Compare WebSocket connections through API Gateway vs Direct connection</p>
        
        <!-- Shared Login Section -->
        <div class="login-shared">
            <h3>üîê Authentication (Shared)</h3>
            <div>
                <input type="text" id="username" placeholder="Username" value="admin">
                <input type="password" id="password" placeholder="Password" value="admin123">
                <select id="userType">
                    <option value="ADMIN">ADMIN</option>
                    <option value="CUSTOMER">CUSTOMER</option>
                    <option value="DEALER">DEALER</option>
                </select>
                <button onclick="login()">Login & Get JWT Token</button>
            </div>
            <div id="loginStatus" class="status" style="display: none;"></div>
            <div id="tokenInfo" style="display: none;">
                <strong>JWT Token Ready</strong>
                <div class="connection-info" id="tokenPreview"></div>
            </div>
        </div>

        <!-- Comparison Panels -->
        <div class="comparison-container">
            <!-- API Gateway Connection -->
            <div class="connection-panel gateway-panel">
                <div class="panel-header">
                    üåê API Gateway Connection
                </div>
                
                <div class="connection-info">
                    <strong>Endpoint:</strong><br>
                    <span class="endpoint-url">http://localhost:8080/ws/notifications</span><br>
                    <small>‚úÖ Goes through API Gateway security & routing</small>
                </div>
                
                <div class="section">
                    <h4>Connection Control</h4>
                    <button id="gatewayConnectBtn" onclick="connectGateway()" disabled>Connect via Gateway</button>
                    <button id="gatewayDisconnectBtn" onclick="disconnectGateway()" disabled>Disconnect</button>
                    <button id="gatewaySendBtn" onclick="sendTestGateway()" disabled>Send Test Message</button>
                    <div id="gatewayStatus" class="status" style="display: none;"></div>
                </div>

                <div class="stats" id="gatewayStats">
                    <span>Status: <strong id="gatewayConnectionStatus">Disconnected</strong></span>
                    <span>Messages: <strong id="gatewayMessageCount">0</strong></span>
                    <span>Errors: <strong id="gatewayErrorCount">0</strong></span>
                </div>

                <div class="section">
                    <h4>Messages</h4>
                    <div id="gatewayMessages" class="messages"></div>
                    <button onclick="clearMessages('gateway')">Clear</button>
                </div>
            </div>

            <!-- Direct Connection -->
            <div class="connection-panel direct-panel">
                <div class="panel-header">
                    üîó Direct Connection
                </div>
                
                <div class="connection-info">
                    <strong>Endpoint:</strong><br>
                    <span class="endpoint-url">http://localhost:8083/ws/notifications</span><br>
                    <small>‚ö†Ô∏è Bypasses API Gateway (direct to service)</small>
                </div>
                
                <div class="section">
                    <h4>Connection Control</h4>
                    <button id="directConnectBtn" onclick="connectDirect()" disabled>Connect Direct</button>
                    <button id="directDisconnectBtn" onclick="disconnectDirect()" disabled>Disconnect</button>
                    <button id="directSendBtn" onclick="sendTestDirect()" disabled>Send Test Message</button>
                    <div id="directStatus" class="status" style="display: none;"></div>
                </div>

                <div class="stats" id="directStats">
                    <span>Status: <strong id="directConnectionStatus">Disconnected</strong></span>
                    <span>Messages: <strong id="directMessageCount">0</strong></span>
                    <span>Errors: <strong id="directErrorCount">0</strong></span>
                </div>

                <div class="section">
                    <h4>Messages</h4>
                    <div id="directMessages" class="messages"></div>
                    <button onclick="clearMessages('direct')">Clear</button>
                </div>
            </div>
        </div>

        <!-- Comparison Results -->
        <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>üìä Connection Comparison Results</h3>
            <div id="comparisonResults">
                <p><em>Connect using both methods to see comparison results...</em></p>
            </div>
        </div>
    </div>

    <script>
        let gatewayClient = null;
        let directClient = null;
        let jwtToken = null;
        
        // Stats tracking
        let stats = {
            gateway: { messages: 0, errors: 0 },
            direct: { messages: 0, errors: 0 }
        };

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            const statusDiv = document.getElementById('loginStatus');
            
            if (!username || !password) {
                showStatus(statusDiv, '‚ùå Please enter username and password', 'error');
                return;
            }

            showStatus(statusDiv, 'üîÑ Authenticating...', 'info');

            try {
                const endpoints = [
                    'http://localhost:8080/api/auth/login',
                    'http://localhost:8081/auth/login'
                ];

                for (const endpoint of endpoints) {
                    console.log(`Trying endpoint: ${endpoint}`);
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Gateway-Request': 'true'
                        },
                        body: JSON.stringify({ username, password, userType })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data && result.data.token) {
                            jwtToken = result.data.token;
                            
                            showStatus(statusDiv, '‚úÖ Authentication successful!', 'success');
                            
                            // Show token info
                            document.getElementById('tokenInfo').style.display = 'block';
                            document.getElementById('tokenPreview').textContent = 
                                jwtToken.substring(0, 50) + '...' + jwtToken.substring(jwtToken.length - 10);
                            
                            // Enable connection buttons
                            document.getElementById('gatewayConnectBtn').disabled = false;
                            document.getElementById('directConnectBtn').disabled = false;
                            
                            return;
                        }
                    }
                }

                showStatus(statusDiv, '‚ùå Authentication failed on all endpoints', 'error');
                
            } catch (error) {
                showStatus(statusDiv, `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        // Gateway connection
        function connectGateway() {
            if (!jwtToken) {
                addMessage('gateway', '‚ùå Please login first', 'error');
                return;
            }

            if (gatewayClient !== null) {
                disconnectGateway();
            }

            const statusDiv = document.getElementById('gatewayStatus');
            showStatus(statusDiv, 'üîÑ Connecting via API Gateway...', 'info');
            addMessage('gateway', 'üîÑ Connecting to http://localhost:8080/ws/notifications', 'system');
            updateConnectionStatus('gateway', 'Connecting...');

            const socket = new SockJS('http://localhost:8080/ws/notifications');
            gatewayClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                debug: (str) => {
                    console.log('Gateway STOMP: ' + str);
                    addMessage('gateway', 'üîß ' + str, 'system');
                },
                onConnect: (frame) => {
                    showStatus(statusDiv, '‚úÖ Gateway Connected!', 'success');
                    addMessage('gateway', '‚úÖ Connected successfully via API Gateway', 'system');
                    updateConnectionStatus('gateway', 'Connected');
                    
                    document.getElementById('gatewayConnectBtn').disabled = true;
                    document.getElementById('gatewayDisconnectBtn').disabled = false;
                    document.getElementById('gatewaySendBtn').disabled = false;
                    
                    // Subscribe to topics
                    gatewayClient.subscribe('/topic/notifications', (msg) => {
                        stats.gateway.messages++;
                        updateStats('gateway');
                        addMessage('gateway', 'üì¨ Topic: ' + msg.body, 'received');
                    });
                    
                    gatewayClient.subscribe('/user/queue/notifications', (msg) => {
                        stats.gateway.messages++;
                        updateStats('gateway');
                        addMessage('gateway', 'üë§ Private: ' + msg.body, 'received');
                    });
                    
                    addMessage('gateway', 'üì° Subscribed to notification topics', 'system');
                    updateComparisonResults();
                },
                onStompError: (frame) => {
                    stats.gateway.errors++;
                    updateStats('gateway');
                    showStatus(statusDiv, '‚ùå Gateway STOMP Error: ' + frame.headers['message'], 'error');
                    addMessage('gateway', '‚ùå STOMP Error: ' + frame.headers['message'], 'error');
                    updateConnectionStatus('gateway', 'Error');
                },
                onWebSocketError: (error) => {
                    stats.gateway.errors++;
                    updateStats('gateway');
                    showStatus(statusDiv, '‚ùå Gateway WebSocket Error', 'error');
                    addMessage('gateway', '‚ùå WebSocket Error: ' + error.message, 'error');
                    updateConnectionStatus('gateway', 'Error');
                },
                onDisconnect: () => {
                    updateConnectionStatus('gateway', 'Disconnected');
                    addMessage('gateway', 'üîå Gateway disconnected', 'system');
                    
                    document.getElementById('gatewayConnectBtn').disabled = false;
                    document.getElementById('gatewayDisconnectBtn').disabled = true;
                    document.getElementById('gatewaySendBtn').disabled = true;
                    updateComparisonResults();
                }
            });

            gatewayClient.activate();
        }

        // Direct connection
        function connectDirect() {
            if (!jwtToken) {
                addMessage('direct', '‚ùå Please login first', 'error');
                return;
            }

            if (directClient !== null) {
                disconnectDirect();
            }

            const statusDiv = document.getElementById('directStatus');
            showStatus(statusDiv, 'üîÑ Connecting directly...', 'info');
            addMessage('direct', 'üîÑ Connecting to http://localhost:8083/ws/notifications', 'system');
            updateConnectionStatus('direct', 'Connecting...');

            const socket = new SockJS('http://localhost:8083/ws/notifications');
            directClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                debug: (str) => {
                    console.log('Direct STOMP: ' + str);
                    addMessage('direct', 'üîß ' + str, 'system');
                },
                onConnect: (frame) => {
                    showStatus(statusDiv, '‚úÖ Direct Connected!', 'success');
                    addMessage('direct', '‚úÖ Connected successfully via direct connection', 'system');
                    updateConnectionStatus('direct', 'Connected');
                    
                    document.getElementById('directConnectBtn').disabled = true;
                    document.getElementById('directDisconnectBtn').disabled = false;
                    document.getElementById('directSendBtn').disabled = false;
                    
                    // Subscribe to topics
                    directClient.subscribe('/topic/notifications', (msg) => {
                        stats.direct.messages++;
                        updateStats('direct');
                        addMessage('direct', 'üì¨ Topic: ' + msg.body, 'received');
                    });
                    
                    directClient.subscribe('/user/queue/notifications', (msg) => {
                        stats.direct.messages++;
                        updateStats('direct');
                        addMessage('direct', 'üë§ Private: ' + msg.body, 'received');
                    });
                    
                    addMessage('direct', 'üì° Subscribed to notification topics', 'system');
                    updateComparisonResults();
                },
                onStompError: (frame) => {
                    stats.direct.errors++;
                    updateStats('direct');
                    showStatus(statusDiv, '‚ùå Direct STOMP Error: ' + frame.headers['message'], 'error');
                    addMessage('direct', '‚ùå STOMP Error: ' + frame.headers['message'], 'error');
                    updateConnectionStatus('direct', 'Error');
                },
                onWebSocketError: (error) => {
                    stats.direct.errors++;
                    updateStats('direct');
                    showStatus(statusDiv, '‚ùå Direct WebSocket Error', 'error');
                    addMessage('direct', '‚ùå WebSocket Error: ' + error.message, 'error');
                    updateConnectionStatus('direct', 'Error');
                },
                onDisconnect: () => {
                    updateConnectionStatus('direct', 'Disconnected');
                    addMessage('direct', 'üîå Direct disconnected', 'system');
                    
                    document.getElementById('directConnectBtn').disabled = false;
                    document.getElementById('directDisconnectBtn').disabled = true;
                    document.getElementById('directSendBtn').disabled = true;
                    updateComparisonResults();
                }
            });

            directClient.activate();
        }

        // Disconnect functions
        function disconnectGateway() {
            if (gatewayClient !== null) {
                gatewayClient.deactivate();
                gatewayClient = null;
            }
        }

        function disconnectDirect() {
            if (directClient !== null) {
                directClient.deactivate();
                directClient = null;
            }
        }

        // Send test messages
        function sendTestGateway() {
            if (gatewayClient && gatewayClient.connected) {
                const message = {
                    content: 'Test from API Gateway connection',
                    timestamp: new Date().toISOString(),
                    sender: 'gateway-client'
                };
                
                gatewayClient.publish({
                    destination: '/app/test',
                    body: JSON.stringify(message)
                });
                
                addMessage('gateway', 'üì§ Sent: ' + JSON.stringify(message), 'sent');
            }
        }

        function sendTestDirect() {
            if (directClient && directClient.connected) {
                const message = {
                    content: 'Test from direct connection',
                    timestamp: new Date().toISOString(),
                    sender: 'direct-client'
                };
                
                directClient.publish({
                    destination: '/app/test',
                    body: JSON.stringify(message)
                });
                
                addMessage('direct', 'üì§ Sent: ' + JSON.stringify(message), 'sent');
            }
        }

        // Helper functions
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status ' + type;
            element.style.display = 'block';
        }

        function addMessage(panel, message, type = 'system') {
            const messagesDiv = document.getElementById(panel + 'Messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages(panel) {
            document.getElementById(panel + 'Messages').innerHTML = '';
        }

        function updateConnectionStatus(panel, status) {
            document.getElementById(panel + 'ConnectionStatus').textContent = status;
        }

        function updateStats(panel) {
            document.getElementById(panel + 'MessageCount').textContent = stats[panel].messages;
            document.getElementById(panel + 'ErrorCount').textContent = stats[panel].errors;
        }

        function updateComparisonResults() {
            const gatewayConnected = gatewayClient && gatewayClient.connected;
            const directConnected = directClient && directClient.connected;
            
            let results = '<h4>Current Status:</h4><ul>';
            
            if (gatewayConnected) {
                results += '<li>‚úÖ API Gateway: Connected successfully</li>';
            } else {
                results += '<li>‚ùå API Gateway: Not connected</li>';
            }
            
            if (directConnected) {
                results += '<li>‚úÖ Direct: Connected successfully</li>';
            } else {
                results += '<li>‚ùå Direct: Not connected</li>';
            }
            
            results += '</ul>';
            
            if (gatewayConnected || directConnected) {
                results += '<h4>Key Differences:</h4><ul>';
                results += '<li><strong>API Gateway:</strong> Includes security validation, CORS handling, and routing</li>';
                results += '<li><strong>Direct:</strong> Bypasses gateway security and routing logic</li>';
                results += '<li><strong>Performance:</strong> Direct connection may have slightly lower latency</li>';
                results += '<li><strong>Security:</strong> Gateway connection provides centralized auth & logging</li>';
                results += '</ul>';
            }
            
            document.getElementById('comparisonResults').innerHTML = results;
        }

        // Initialize
        addMessage('gateway', 'üåê Ready to connect via API Gateway', 'system');
        addMessage('direct', 'üîó Ready to connect directly', 'system');
    </script>
</body>
</html>